<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@4.11.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@4.11.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.min.js"></script>
  </head>
  <body>
    <div id="terminal" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
    <script>
      const fontFamily = "{fontFamily}";
      const fontSize = "{fontSize}";
      const option = { cursorBlink: true };

      if (fontFamily) {
        option["fontFamily"] = fontFamily;
      }

      if (fontSize) {
        option["fontSize"] = fontSize;
      }

      const terminal = new Terminal(option);
      const fitAddon = new FitAddon.FitAddon();
      terminal.loadAddon(fitAddon);
      terminal.open(document.getElementById('terminal'));
      terminal.focus();
      fitAddon.fit();

      const socket = new WebSocket('ws://localhost:{port}/ws');

      // workaround
      // for redraw terminal screen when reload window
      const redraw = (socket, msg) => {
        msg.data.cols--
        terminal.resize(msg.data.cols,msg.data.rows)
        socket.send(JSON.stringify(msg));

        msg.data.cols++
        terminal.resize(msg.data.cols,msg.data.rows)
        socket.send(JSON.stringify(msg));
      }

      socket.onopen = () => {
        const msg = {
          event: "resize",
          data: {
            "cols": terminal.cols,
            "rows": terminal.rows,
          },
        };
        socket.send(JSON.stringify(msg));

        redraw(socket, msg)

        terminal.onData(data => {
          switch(socket.readyState) {
            case WebSocket.CLOSED:
            case WebSocket.CLOSING:
              terminal.dispose();
              return;
          }
          const msg = {
            event: "sendKey",
            data: data,
          }
          socket.send(JSON.stringify(msg));
        })

        socket.onclose = () => {
          terminal.writeln('[Disconnected]');
        }

        socket.onmessage = (e) => {
          terminal.write(e.data);
        }

        terminal.onResize((size) => {
          terminal.resize(size.cols, size.rows);
          const msg = {
            event: "resize",
            data: {
              cols: size.cols,
              rows: size.rows,
            },
          }
          socket.send(JSON.stringify(msg));
        });

        window.onbeforeunload = (event) => {
          socket.close();
        }

        window.addEventListener("resize", () => {
          fitAddon.fit()
        })
      }
    </script>
  </body>
</html>
